apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sallowedimages
spec:
  crd:
    spec:
      names:
        kind: K8sAllowedImages
      validation:
        openAPIV3Schema:
          properties:
            images:
              type: array
              items:
                type: string
                description: A list of allowed image URLs. Each image URL must be a prefix of the image URL used in the Pod spec.
            namespaces:
              type: array
              items:
                type: string
                description: A list of namespaces to which the constraint applies. If empty, the constraint applies to all namespaces.
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sallowedimages
       
        # Check violations for conatainers.
        violation[{"msg": msg}] {
          # Check object is created in namespace matching any of parameters namespaces.
          namespaces := object.get(input.parameters, "namespaces", [".*"])
          regex.match(namespaces[_], input.review.object.metadata.namespace)
          # Check object is using an image that is not allowed.
          container := input.review.object.spec.containers[_]
          not strings.any_prefix_match(input.parameters.images, container.image)
          #satisfied := [good | repo = input.parameters.images[_] ; good = startswith(container.image, repo)]
          #not any(satisfied)
          msg := sprintf("container <%v> in namespace <%v> has an invalid image repo <%v>, allowed repos are %v", [container.name, container.image, input.review.object.metadata.namespace, input.parameters.images])
        }

        # Check violations for init containers.
        violation[{"msg": msg}] {
          # Check object is created in any of parameters namespaces.
          namespaces := object.get(input.parameters, "namespaces", [".*"])
          regex.match(namespaces[_], input.review.object.metadata.namespace)
          # Check object is using an image that is not allowed.
          container := input.review.object.spec.initContainers[_]
          not strings.any_prefix_match(input.parameters.images, container.image)
          #satisfied := [good | repo = input.parameters.images[_] ; good = startswith(container.image, repo)]
          #not any(satisfied)
          msg := sprintf("container <%v> in namespace <%v> has an invalid image repo <%v>, allowed repos are %v", [container.name, container.image, input.review.object.metadata.namespace, input.parameters.images])
        }
