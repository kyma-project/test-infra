# Environment variables expected by this makefile
# DOCKER_TAG - dynamic tag for image
# DOCKER_PUSH_REPOSITORY - URL set by prow preset
# DOCKER_PUSH_DIRECTORY

IMG_NAME = github-webhook-gateway
IMG = $(DOCKER_PUSH_REPOSITORY)$(DOCKER_PUSH_DIRECTORY)/$(IMG_NAME)


# build and push on PR, tag with PR number
.PHONY: ci-pr
ci-pr: build-image push-image validate
push-image: build-image
build-image: validate


# build and push on postsubmit, tag with commit ID and current
.PHONY: ci-release
ci-release: build-image tag-image push-image validate
tag-image: build-image
build-image: validate


# tag image with current tag
.PHONY: tag-image
tag-image:
	@echo "___ Tagging as current ___"
	docker tag $(IMG):$(DOCKER_TAG) $(IMG):current
ifdef DOCKER_POST_PR_TAG
	@echo "___ Tagging with pr number ___"
	docker tag $(IMG):$(DOCKER_TAG) $(IMG):$(DOCKER_POST_PR_TAG)
endif


# build image and tag it with commit ID or PR number
.PHONY: build-image
build-image:
	docker build -t $(IMG):$(DOCKER_TAG) --build-arg commit=$(DOCKER_TAG) -f Dockerfile .


# push image with all tags
.PHONY: push-image
push-image:
	@echo "___ Pushing image with all tags ___"
	docker push $(IMG)


# validate
.PHONY: validate
validate:
	./before-commit.sh ci


.PHONY: clean
clean:
	rm -f $(APP_NAME)