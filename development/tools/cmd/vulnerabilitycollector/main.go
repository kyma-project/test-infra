package main

import (
	"context"
	"flag"
	"fmt"
	"os"
	"strings"

	"google.golang.org/genproto/googleapis/devtools/containeranalysis/v1beta1/grafeas"

	log "github.com/sirupsen/logrus"

	"github.com/kyma-project/test-infra/development/tools/pkg/vulnerabilitycollector"
)

var (
	project     = flag.String("project", "", "Project ID [Required]")
	projectPath = flag.String("path", "", "Specify a sub-path in the project if you don't want to run against all public images")
	whitelist   = flag.String("whitelist", "", "Comma separated list of paths that are whitelisted for scanning")
	region      = flag.String("region", "", "Region shortcode, eu for Europe, us for United States, leave empty for global")
	dryRun      = flag.Bool("dryRun", true, "Dry Run enabled, nothing is deleted")
)

func main() {
	ctx := context.Background()
	flag.Parse()

	if *project == "" {
		fmt.Fprintln(os.Stderr, "missing -project flag")
		flag.Usage()
		os.Exit(2)
	}

	fmt.Println(*region)
	if *region != "" && *region != "us" && *region != "eu" {
		fmt.Fprintln(os.Stderr, "missing proper value for -region flag")
		flag.Usage()
		os.Exit(2)
	}

	changePrefix := ""
	if *dryRun {
		changePrefix = "[DRYRUN] "
	}

	imageList, err := vulnerabilitycollector.GetLatestImageList(ctx, *project, *region, *projectPath, *whitelist, *dryRun) // TODO: negate dryRun
	if err != nil {
		log.Fatalf("Couldn't get image list from Google Container registry: %s", err.Error())
	}

	var occurenceList []*grafeas.Occurrence
	for _, url := range imageList {
		vs, err := vulnerabilitycollector.FindVulnerabilityOccurrencesForImage(ctx, *project, !*dryRun, url)
		if err != nil {
			log.Fatalf("Could not get authenticated client: %v", err)
		}
		occurenceList = append(occurenceList, vs...)
	}

	log.Printf("%sFound %d vulnerabilities for specified project in %d containers scanned", changePrefix, len(occurenceList), len(imageList))

	var count int
	var warn int
	var packages map[string]string
	packages = make(map[string]string)
	for _, element := range occurenceList {

		req := element.GetVulnerability()
		if strings.Contains("HIGH", req.Severity.String()) {

			log.Warnf("Severity '%s' for package '%s' with version '%s'", req.Severity, req.PackageIssue[0].AffectedLocation.Package, req.PackageIssue[0].AffectedLocation.Version.Name)
			packages[req.PackageIssue[0].AffectedLocation.Package] = req.PackageIssue[0].AffectedLocation.Version.Name
			warn++

		}
		count++
	}
	if warn > 0 {
		log.Warnf("%sNumber of High issues %d", changePrefix, warn)
	}

	log.Infof("%sNumber of issues %d", changePrefix, count)

	// vulnerabilitycollector.WriteToSlack(!*dryRun, fmt.Sprintf("Docker URL: %s", *url), warn, packages, count)

}
