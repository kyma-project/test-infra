# Render Templates

## Overview

The Render Templates is a tool that reads the configuration in the [`templates/config.yaml`](../../../../templates/config.yaml) file to generate output files, such as Prow component jobs.

The `config.yaml` file specifies the following for the Render Templates:
- Templates it must use to generate the output files
- The name and location of the output files
- Values it must use to generate the output files

### Data for templates 

The Render Template passes data used to generate files from templates in the **$.Values** and **$.Global** variables. The values of these variables are created from the `config.yaml` file. The **Global** variable holds data from the **global** key. The Render Template generates the values of the **Values** variable from scratch for each Prow job. It is generated by merging ConfigSets. Each ConfigSet is a map defined in one of three possible places in the `config.yaml` file:

- **Global ConfigSets** defined in the **globalSets** key:

```yaml
globalSets:
  image_bootstrap:
    image: "eu.gcr.io/kyma-project/test-infra/bootstrap:v20200831-e46c648b"
```

   ConfigSets defined in **globalSets** hold data used to generate multiple files. A good example of such usage is the `image_bootstrap` global ConfigSet which defines a bootstrap image to use in Prow jobs. 
 
 
- **Local ConfigSets** defined under the **localSets** parameter for each **to** key:

```yaml
render:
  - to: ../prow/jobs/test-infra/buildpack.yaml
    localSets:
      default:
        skip_report: "false"
        max_concurrency: "10"
        branches:
        - "^master$"
      presubmit:
        type_presubmit: "true"
        labels:
          preset-build-pr: "true"
      postsubmit:
        type_postsubmit: "true"
        cluster: "trusted-workload"
```

   ConfigSets defined in **localSets** have a scope limited to the generated file in which they are defined. Use **localSets** to hold data that is common within the generated file.

- **One-job ConfigSets** defined in the **jobConfig** key:

```yaml
jobConfigs:
  - repoName: "github.com/kyma-project/test-infra"
    jobs:
    - jobConfig:
        name: "pre-test-infra-bootstrap"
        run_if_changed: "^prow/images/bootstrap/"
        args:
        - "/home/prow/go/src/github.com/kyma-project/test-infra/prow/images/bootstrap"
```

ConfigSets defined in **jobConfig** set data for one job. It should keep values specific for this job only.

Render Templates builds the **Values** variable by merging ConfigSets from **globalSets** first. If the job inherits the default ConfigSet from **globalSets**, it's merged first and all the other ConfigSets from **globalSets** are merged after. Then, ConfigSets from **localSets** are merged. Again, if the job inherits the default ConfigSet from **localSets**, it's merged first and then all other ConfigSets from **localSets** are merged. ConfigSets other than default are merged in any order during **globalSets** and **localSets** phases. ConfigSets from **jobConfig** are merged as the last ones. Existing keys in the **Values** variable are overwritten by values from the merged ConfigSets.

Every job under the **inheritedConfigs** key specifies which ConfigSets are inherited. This key holds a list of ConfigSets names from **globalSets** and **localSets**.

```yaml
jobConfigs:
  - repoName: "github.com/kyma-project/test-infra"
    jobs:
    - inheritedConfigs:
        global:
          - "image_bootstrap"
        local:
          - "default"
          - "presubmit"
        jobConfig:
          name: "pre-test-infra-bootstrap"
          run_if_changed: "^prow/images/bootstrap/"
```

## Usage

To run this tool, use this command:

```bash
go run development/tools/cmd/rendertemplates/main.go --config templates/config.yaml
```

### Flags

This tool uses one flag:

| Name | Required | Description                                                                                          |
| ------------------------ | :------: | --------------------------------------------------------------------------------------------------- |
| **&#x2011;&#x2011;config**  |   Yes    | Generates output files based on the definition of the configuration file. |        
