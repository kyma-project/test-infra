# Render Templates

## Overview

The Render Templates is a tool that reads the configuration in the [`templates/config.yaml`](../../../../templates/config.yaml) file to generate output files, such as Prow component jobs.

The `config.yaml` file specifies the following for the Render Templates:
- Templates it must use to generate the output files
- The name and location of the output files
- Values it must use to generate the output files

### Data for templates 

The Render Template pass data used to generate files from templates under a **`$.Values`** and **`$.Global`** variables. Variables values are created from config.yaml file. Global variable holds data from **`global`** key. Whereas Render Template generate `Values` variable value for each prowjob from scratch. It is generated by merging configsets. Each configset is a map. There are three places where configset can be defined in config.yaml file.

**Global configsets** are defined under **`globalSets`** key.

```yaml
globalSets:
  image_bootstrap:
    image: "eu.gcr.io/kyma-project/test-infra/bootstrap:v20200831-e46c648b"
```

Configsets defined in `globalSets` should hold data used to generate multiple files. A good example such usage is `image_bootstrap` global configset, which define bootstrap image to use in prowjobs. 
 
 
**Local configsets** are defined for each **`to`** key under **`localSets`** key.

```yaml
render:
  - to: ../prow/jobs/test-infra/buildpack.yaml
    localSets:
      default:
        skip_report: "false"
        max_concurrency: "10"
        branches:
        - "^master$"
      presubmit:
        type_presubmit: "true"
        labels:
          preset-build-pr: "true"
      postsubmit:
        type_postsubmit: "true"
        cluster: "trusted-workload"
```

Configsets defined in `localSets` have scope limited to the generated file under which they are defined. `localSets` should be used to hold data which is common within the generated file.

Last place where configset can be defined is a **`jobConfig`** key.

```yaml
jobConfigs:
  - repoName: "github.com/kyma-project/test-infra"
    jobs:
    - jobConfig:
        name: "pre-test-infra-bootstrap"
        run_if_changed: "^prow/images/bootstrap/"
        args:
        - "/home/prow/go/src/github.com/kyma-project/test-infra/prow/images/bootstrap"
```

Configset defined in `jobConfig` sets data for one job only and should keep values specific for the job.

Render Templates builds Values variable by merging configsets from `globalSets` first. If job inherits `default` configset from `globalSets`, it's merged first and all other configsets from `globalSets` are merged after merging `default` configset. Next configsets from `localSets` are merged. Again, if job inherit `default` configset from `localSets`, tool ensure it's merged first and then all other configsets from `localSets`. Configsets other than `default` are merged in any order during `globalSets` and `localSets` phases. Configset from `jobConfig` is merged as a last one after two earlier phases. Existing keys in **`Values`** variable are overwritten by values from merged configset.

Every job under `inheritedConfigs` key specify which configsets inherits. This key holds list of configsets names from `globalSets` and `localSets`.

```yaml
jobConfigs:
  - repoName: "github.com/kyma-project/test-infra"
    jobs:
    - inheritedConfigs:
        global:
          - "image_bootstrap"
        local:
          - "default"
          - "presubmit"
        jobConfig:
          name: "pre-test-infra-bootstrap"
          run_if_changed: "^prow/images/bootstrap/"
```

## Usage

To run this tool, use this command:

```bash
go run development/tools/cmd/rendertemplates/main.go --config templates/config.yaml
```

### Flags

This tool uses one flag:

| Name | Required | Description                                                                                          |
| ------------------------ | :------: | --------------------------------------------------------------------------------------------------- |
| **&#x2011;&#x2011;config**  |   Yes    | Generates output files based on the definition of the configuration file. |        
