# Render Templates

## Overview

The Render Templates is a tool that reads the configuration from the [`templates/config.yaml`](../../../../templates/config.yaml) file and data files from the [`templates/data`](../../../../templates/data) directory to generate output files, such as Prow component jobs. While the `config.yaml` file can hold configuration for an output file, you can place such data within the data files that hold configuration for related output files. Having separate files with grouped data is cleaner and easier to maintain than one huge config file.

The `config.yaml` file and the data files specify the following for the Render Templates:
- Templates it must use to generate the output files
- The name and location of the output files
- Values it must use to generate the output files

### Data for templates

The Render Templates passes data used to generate files from templates in the **$.Values** and **$.Global** variables. The values of these variables are created from the `config.yaml` file and data files stored in the `templates/data` directory. The **Global** variable holds data from the **global** key. The Render Templates generates the values of the **Values** variable from scratch for each Prow job. **Values** variable is generated by merging ConfigSets. Each ConfigSet is a map defined in one of three possible places:

- **Global ConfigSets** defined in the **globalSets** key in the `config.yaml` file:

```yaml
globalSets:
  image_bootstrap:
    image: "eu.gcr.io/kyma-project/test-infra/bootstrap:v20200831-e46c648b"
```

   ConfigSets defined in **globalSets** hold data used to generate multiple files. A good example of such usage is the `image_bootstrap` global ConfigSet which defines a bootstrap image to use in Prow jobs.


- **Local ConfigSets** defined under the **localSets** parameter for each **to** key in the `config.yaml` file or in data files in the `templates/data` directory:

```yaml
render:
  - to: ../prow/jobs/test-infra/buildpack.yaml
    localSets:
      default:
        skip_report: "false"
        max_concurrency: "10"
        branches:
        - "^main$"
      presubmit:
        type_presubmit: "true"
        labels:
          preset-build-pr: "true"
      postsubmit:
        type_postsubmit: "true"
        cluster: "trusted-workload"
```

   ConfigSets defined in **localSets** have a scope limited to the generated file in which they are defined. Use **localSets** to hold data that is common within the generated file.

- **One-job ConfigSets** defined in the **jobConfig** key:

```yaml
jobConfigs:
  - repoName: "kyma-project/test-infra"
    jobs:
    - jobConfig:
        name: "pre-test-infra-bootstrap"
        run_if_changed: "^prow/images/bootstrap/"
        args:
        - "/home/prow/go/src/github.com/kyma-project/test-infra/prow/images/bootstrap"
```

ConfigSets defined in **jobConfig** set data for one job. Use such ConfigSets to keep values specific for one job only.

Every job under the **inheritedConfigs** key specifies which ConfigSets are inherited. This key holds a list of ConfigSets names from **globalSets** and **localSets**.

```yaml
jobConfigs:
  - repoName: "kyma-project/test-infra"
    jobs:
      - jobConfig:
          name: "pre-test-infra-bootstrap"
          run_if_changed: "^prow/images/bootstrap/"
        inheritedConfigs:
          global:
            - "image_bootstrap"
          local:
            - "default"
            - "presubmit"
```

Component job defined in **jobConfig** can be used to generate multiple job definitions for a single component. It is defined by having a `path` value, and by not having a `name` value. This type of config holds two additional lists of configSets named **preConfigs** and **postConfigs**, which hold lists of global and local ConfigSets used for presubmit and postsubmit jobs.

```yaml
localSets:
  jobConfig_pre:
    labels:
      preset-build-pr: "true"
  jobConfig_post:
    labels:
      preset-build-main: "true"
jobConfigs:
  - repoName: "github.com/kyma-project/kyma"
    jobs:
      - jobConfig:
          path: components/application-gateway
          args:
            - "/home/prow/go/src/github.com/kyma-project/kyma/components/application-gateway"
          run_if_changed: "^components/application-gateway/|^common/makefiles/"
          release_since: "1.7"
        inheritedConfigs:
          global:
            - "jobConfig_default"
            - "image_buildpack-golang"
            - "jobConfig_generic_component"
            - "jobConfig_generic_component_kyma"
            - "extra_refs_test-infra"
          preConfigs:
            global:
              - "jobConfig_presubmit"
            local:
              - "jobConfig_pre"
          postConfigs:
            global:
              - "jobConfig_postsubmit"
              - "disable_testgrid"
            local:
              - "jobConfig_post"
```

The Render Templates tool can generate precommit and postcommit job definitions from a single jobConfig. Job defined in **jobConfigPre** and **jobConfigPost** can generate precommit and postcommit job definitions for a single job. This type of config holds two additional lists of values named **jobConfigPre** and **jobConfigPost**, which holds values used for presubmit and postsubmit jobs, as well as two lists of configSets named **preConfigs** and **postConfigs**, which hold lists of global and local ConfigSets used for presubmit and postsubmit jobs.

```yaml
jobConfigs:
  - repoName: kyma-project/control-plane
    jobs:
      - jobConfig:
          labels:
            preset-common: "true"
        jobConfigPre:
          name: pre-main-kcp-cli
          run_if_changed: "^tools/cli"
        jobConfigPost:
          name: post-main-kcp-cli
          labels:
            preset-build-artifacts-main: "true"
        inheritedConfigs:
          global:
            - "jobConfig_default"
          local:
            - "jobConfig_default_kcp"
          preConfigs:
            global:
              - "jobConfig_presubmit"
          postConfigs:
            global:
              - "jobConfig_postsubmit"
              - "disable_testgrid"
```

The Render Templates builds the **Values** variable by merging ConfigSets from **globalSets** first. If the job inherits the `default` ConfigSet from **globalSets**, it is merged first and all other ConfigSets from **globalSets** are merged afterwards. Then, the Render Templates merges ConfigSets from **localSets**. Again, if the job inherits the `default` ConfigSet from **localSets**, it's merged first and then all the other ConfigSets from **localSets** are merged. ConfigSets other than default are merged in any order during the **globalSets** and **localSets** phases. ConfigSets from **jobConfig** are merged as the last ones. Existing keys in the **Values** variable are overwritten by values from the merged ConfigSets.


## Usage

To run this tool, use this command:

```bash
go run development/tools/cmd/rendertemplates/main.go --config templates/config.yaml
```

### Flags

This tool uses one flag:

| Name | Required | Description                                                                                          |
| ------------------------ | :------: | --------------------------------------------------------------------------------------------------- |
| **&#x2011;&#x2011;config**  |   Yes    | Generates output files based on the definition of the configuration file. |
| **&#x2011;&#x2011;show-output-dir**  |   No    | Prints out the paths to data files and to the generated files. |
