apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: terraform-executor
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.36.0"
    tekton.dev/categories: IaC
    tekton.dev/tags: terraform
    tekton.dev/displayName: "terraform-executor"
    tekto.dev/platforms: "linux/amd64"
spec:
  description: >-
    The image-builder Task builds an OCI image from a Dockerfile.
    The image is signed with signify and pushed to Kyma repositories.
    The Task uses the image-builder tool to build the image.
    Documentation of image-builder tool used by this Task : https://github.com/kyma-project/test-infra/tree/main/development/image-builder
  workspaces:
    - name: repo
      description: "The workspace stores sources to apply. Usually, this should be a workspace shared with other tasks."
      mountPath: /home/prow/go
  params:
    - name: terraform_action
      description: "Terraform action to execute."
      type: string
    - name: module_path
      description: "Path to the terraform config files."
      type: string
    - name: SHA
      description: "Commit hash with terraform config files."
      type: string
    - name: REPO_OWNER
      description: "GitHub org that triggers the job. Variable set by Prow."
      type: string
    - name: REPO_NAME
      description: "GitHub repo that triggers the job. Variable set by Prow."
      type: string
    - name: github-token-secret
      type: string
      description: Name of the secret holding the kyma bot github token.
      default: kyma-bot-github-token
    - name: additional_terraform_args
      description: "Additional terraform arguments."
      type: array
      default: ["-no-color"]
  steps:
    - name: terraform-init
      image: europe-docker.pkg.dev/kyma-project/prod/test-infra/terraform:v20230215-6bf03a31
      workingDir: /home/prow/go/src/github.com/$(params.REPO_OWNER)/$(params.REPO_NAME)
      command:
        - /bin/terraform
      args:
        - -chdir=$(params.module_path)
        - init
        - -input=false
      resources:
        requests:
          memory: 500Mi
          cpu: 300m
    - name: terraform-execute
      image: europe-docker.pkg.dev/kyma-project/prod/test-infra/terraform:v20230215-6bf03a31
      workingDir: /home/prow/go/src/github.com/$(params.REPO_OWNER)/$(params.REPO_NAME)
      command:
        - /tfcmt/tfcmt
      args:
        - -owner=$(params.REPO_OWNER)
        - -repo=$(params.REPO_NAME)
        - -sha=$(params.SHA)
        - $(params.terraform_action)
        - --
        - terraform
        - -chdir=$(params.module_path)
        - $(params.terraform_action)
        - -input=false
        - "$(params.additional_terraform_args[*])"
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.github-token-secret)
              key: token
      resources:
        requests:
          memory: 500Mi
          cpu: 300m
