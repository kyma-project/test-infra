# Manage component jobs with templates

This document describes how to define, modify, and remove ProwJobs for Kyma components using predefined templates that create both presubmit and postsubmit jobs for your component.

>**NOTE:** There are two templates that you can use to generate your component job definitions, `component.yaml` and `generic-component.yaml`. Use the recommended `generic-component.yaml` template that is the latest version using a generic bootstrap. If you decide to use `component.yaml`, define a proper buildpack.

<div tabs name="add-component-jobs">
  <details>
  <summary>
  Add component jobs
  </summary>

Follow these steps:

1. Edit the configuration file.

Go to `templates/config.yaml` and add a new entry with your component details to the `render` list under the `templates` section.

See an example that defines the `api-controller` component from the `kyma` repository using the `go1.12` buildpack:

```yaml
  - from: templates/component.yaml
    render:
      - to: ../prow/jobs/kyma/components/api-controller/api-controller.yaml
        values:
          <<: *go_kyma_component_1_12
          path: components/api-controller
          optional: true
    ...
```

Such an entry uses the `component.yaml` template to create the `api-controller.yaml` file under the `/prow/jobs/kyma/components/api-controller/` subfolder, with presubmit and postsubmit jobs for this component. Set the **optional** parameter to `true` for this job to be optional on pull requests (PRs) and not to block others.

> **NOTE:** Make sure that the yaml file and the component folder name are the same as the name of the Kyma component. Also, all `yaml` files in the whole `jobs` structure need to have unique names.

Use the buildpack for Go or Node.js applications provided in the `test-infra` repository. It is the standard mechanism for defining ProwJobs. If the buildpack you want to use is not there yet, you have to add it. When you add a new buildpack, follow the example of the already defined ones.

2. Generate jobs.

Run this command to generate jobs previously defined in the `config.yaml` file:

```bash
go run development/tools/cmd/rendertemplates/main.go --config templates/config.yaml
```

As a result, the Render Templates tool generates the requested job files.

3. Check your configuration locally.

Use the `development/validate-config.sh` script to validate your Prow configuration. The script accepts three arguments:

- the path to the plugins configuration file (`prow/plugins.yaml`)
- the path to the generic configuration file (`prow/config.yaml`)
- the path to the directory with job definitions (`prow/jobs/`)

See an example:

```bash
cd $GOPATH/src/github.com/kyma-project/test-infra
./development/validate-config.sh prow/plugins.yaml prow/config.yaml prow/jobs/
```

4. Merge the changes.

Create a PR with your changes in the `config.yaml` file and the job files generated by the Render Templates.

After your PR is reviewed and approved, merge the changes to the `test-infra` repository. The job configuration is automatically applied on the Prow production cluster. The `config_updater` plugin configured in the `prow/plugins.yaml` file adds a comment to the PR:

![msg](./assets/msg-updated-config.png).

5. Create a Makefile for your component.

Buildpacks require a `Makefile` defined in your component directory under the `kyma` repository.  
The `Makefile` has to define the **ci-release** target that is executed for a PR issued against the release branch.

See an example of a `Makefile` for the Console Backend Service component that already uses the generic buildpack:

```Makefile
APP_NAME = console-backend-service
APP_PATH = components/$(APP_NAME)
BUILDPACK = eu.gcr.io/kyma-project/test-infra/buildpack-golang-toolbox:v20190930-d28d219
SCRIPTS_DIR = $(realpath $(shell pwd)/../..)/scripts

include $(SCRIPTS_DIR)/go-dep.mk

VERIFY_IGNORE := /vendor\|/automock\|/testdata\|/pkg

.PHONY: path-to-referenced-charts
path-to-referenced-charts:
	@echo "resources/core"

```

> **NOTE** Add a tab before each command.

If your job involves pushing a Docker image, its name is based on the following environment variables:

- **DOCKER_TAG** - refers to the Docker tag set by the `build.sh` script.
- **DOCKER_PUSH_DIRECTORY** - points to the directory in the Docker repository where the image is pushed. Set it in the job definition by adding the **preset-build-pr**, **preset-build-master**, or **preset-build-release** Preset.
- **DOCKER_PUSH_REPOSITORY** - is the Docker repository where the image is pushed. It is set in the job definition by the **preset-docker-push-repository** Preset.

6. Remove the **optional** parameter from your job definition.

Create another PR in the `test-instra` repository that removes the **optional** parameter from your job definition in the `templates/config.yaml` file. This changes your job into obligatory to pass on all PRs.

7. Define tests for your component.

To check if your configuration is correct, write a Go test. Add your new test to the `development/tools/jobs/kyma/components_test.go` file for the `test-infra-test-jobs-yaml-definitions` presubmit job to execute it.
If you have access to the Prow cluster, there is an option to test a ProwJob on it. For details, see the [official documentation](https://github.com/kubernetes/test-infra/blob/master/prow/build_test_update.md#how-to-test-a-prowjob).

When writing tests for a new component, use the `tester.GetKymaReleasesSince({next release})` function to create release jobs tests. This automatically checks whether new release jobs were created in the release process.

</details>
<details>
<summary>
Modify component jobs
</summary>

To change component job configuration, follow these steps:

1. In the `config.yaml` file, change the name of the file where the jobs are generated. For example, add the suffix `deprecated`. Change the path to this file in tests accordingly.
2. Add `until: {last release}` to this configuration. It specifies the release until which this component version is valid.
3. Create a new entry with the new configuration. Set the `to` field to point to the file responsible for storing jobs.
4. Add `since: {next release}` to the new entry. It specifies the release from which this component version is valid.

See this example:

Buildpack for the API Controller has changed from `go1.11` to `go.12` in release 1.5. This is the component configuration before the buildpack change:

```yaml
      - to: ../prow/jobs/kyma/components/api-controller/api-controller.yaml
        values:
          <<: *go_kyma_component_1_11
          path: components/api-controller
```

This is what the configuration created after the buildpack change looks like:

```yaml
      - to: ../prow/jobs/kyma/components/api-controller/api-controller.yaml
        values:
          <<: *go_kyma_component_1_12
          path: components/api-controller
          since: '1.5'
      - to: ../prow/jobs/kyma/components/api-controller/api-controller-deprecated.yaml
        values:
          <<: *go_kyma_component_1_11
          path: components/api-controller
          until: '1.4'
```

5. Modify tests.

When changing tests, use the function `tester.GetKymaReleasesUntil({last release})` in place of `tester.GetAllKymaReleases` to test older releases. Use the function `tester.GetKymaReleasesSince({next release})` to create release jobs tests for future releases. This automatically checks whether new release jobs were created when doing a release.

</details>
<details>
<summary>
Remove component jobs
</summary>

To remove a component from Prow, follow these steps:

1. In the `config.yaml` file, remove the entries under the `templates` section that refer to your component.
2. Manually remove all files and the component folder from `/prow/jobs`.
3. Delete tests for the component jobs.

</details>
</div>
