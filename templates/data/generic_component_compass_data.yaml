templates:
  - from: generic.tmpl
    render:
      - to: ../../prow/jobs/incubator/compass/compass-build.yaml
        localSets:
          image-builder-buildkit:
            image: eu.gcr.io/sap-kyma-neighbors-dev/kaniko-build:v20220928-3d2ace1b4-buildkit
            pubsub_project: "sap-kyma-prow"
            pubsub_topic: "prowjobs"
            skip_report: "false"
            max_concurrency: 10
            decorate: "true"
            annotations:
              container.apparmor.security.beta.kubernetes.io/test: unconfined
              container.seccomp.security.alpha.kubernetes.io/test: unconfined
            labels:
              preset-sa-gcr-push: "true"
            command: "/kaniko-build"
            env:
              BUILDKITD_FLAGS: "--oci-worker-no-process-sandbox"
            volumes:
              - name: share
                emptyDir: true
              - name: config
                configMapName: kaniko-build-config
            volumeMounts:
              - mountPath: /home/user/.local/share/buildkit
                name: share
              - name: config
                mountPath: /config
                readOnly: true
        jobConfigs:

        # Compass repo build jobs
          - repoName: "github.com/kyma-incubator/compass"
            jobs:
            # Operations controller build jobs
              - jobConfig:
                  name: pull-operations-controller-build
                  args:
                    - "--name=operations-controller"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/operations-controller"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/operations-controller/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-operations-controller-build
                  args:
                    - "--name=operations-controller"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/operations-controller"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/operations-controller/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Connector build jobs
              - jobConfig:
                  name: pull-connector-build
                  args:
                    - "--name=connector"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/connector"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/connector/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-connector-build
                  args:
                    - "--name=connector"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/connector"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/connector/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Director build jobs
              - jobConfig:
                  name: pull-director-build
                  args:
                    - "--name=director"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/director"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/director/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-director-build
                  args:
                    - "--name=director"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/director"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/director/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Hydrator build jobs
              - jobConfig:
                  name: pull-hydrator-build
                  args:
                    - "--name=hydrator"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/hydrator"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/hydrator/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-hydrator-build
                  args:
                    - "--name=hydrator"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/hydrator"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/hydrator/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # System-broker build jobs
              - jobConfig:
                  name: pull-system-broker-build
                  args:
                    - "--name=system-broker"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/system-broker"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/system-broker/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-system-broker-build
                  args:
                    - "--name=system-broker"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/system-broker"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/system-broker/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # External-services-mock build jobs
              - jobConfig:
                  name: pull-external-services-mock-build
                  args:
                    - "--name=external-services-mock"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/external-services-mock"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/external-services-mock/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-external-services-mock-build
                  args:
                    - "--name=external-services-mock"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/external-services-mock"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/system-broker/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Connectivity-adapter build jobs
              - jobConfig:
                  name: pull-connectivity-adapter-build
                  args:
                    - "--name=connectivity-adapter"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/connectivity-adapter"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/connectivity-adapter/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-connectivity-adapter-build
                  args:
                    - "--name=connectivity-adapter"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/connectivity-adapter"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/system-broker/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Pairing-adapter build jobs
              - jobConfig:
                  name: pull-pairing-adapter-build
                  args:
                    - "--name=pairing-adapter"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/pairing-adapter"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/pairing-adapter/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-pairing-adapter-build
                  args:
                    - "--name=pairing-adapter"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/pairing-adapter"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/pairing-adapter/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Gateway build jobs
              - jobConfig:
                  name: pull-gateway-build
                  args:
                    - "--name=gateway"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/gateway"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/gateway/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-gateway-build
                  args:
                    - "--name=gateway"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/gateway"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/gateway/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Schema-migrator build jobs
              - jobConfig:
                  name: pull-schema-migrator-build
                  args:
                    - "--name=schema-migrator"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/schema-migrator"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/schema-migrator/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-schema-migrator-build
                  args:
                    - "--name=schema-migrator"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/schema-migrator"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/schema-migrator/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

            # Tests build jobs
              - jobConfig:
                  name: pull-tests-build
                  args:
                    - "--name=tests"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=tests"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^tests/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-tests-build
                  args:
                    - "--name=tests"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=tests"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^tests/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

        # Ord-service repo build jobs
          - repoName: "github.com/kyma-incubator/ord-service"
            jobs:
              - jobConfig:
                  name: pull-ord-service-build
                  args:
                    - "--name=ord-service"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/ord-service"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/ord-service/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-ord-service-build
                  args:
                    - "--name=ord-service"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=components/ord-service"
                    - "--dockerfile=Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^components/ord-service/"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit

        # Compass-console repo build jobs
          - repoName: "github.com/kyma-incubator/compass-console"
            jobs:
              - jobConfig:
                  name: pull-compass-console-build
                  args:
                    - "--name=compass-console"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=."
                    - "--dockerfile=compass/Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^compass/|^components/|^shared/|^package.json"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-compass-console-build
                  args:
                    - "--name=compass-console"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=."
                    - "--dockerfile=compass/Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^compass/|^components/|^shared/|^package.json"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit


