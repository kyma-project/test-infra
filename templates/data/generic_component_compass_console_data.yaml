templates:
  - from: generic.tmpl
    render:
      - to: ../../prow/jobs/incubator/compass-console/compass-console-build.yaml
        localSets:
          image-builder-buildkit:
            image: eu.gcr.io/sap-kyma-neighbors-dev/kaniko-build:v20220928-3d2ace1b4-buildkit
            pubsub_project: "sap-kyma-prow"
            pubsub_topic: "prowjobs"
            skip_report: "false"
            max_concurrency: 10
            decorate: "true"
            annotations:
              container.apparmor.security.beta.kubernetes.io/test: unconfined
              container.seccomp.security.alpha.kubernetes.io/test: unconfined
            labels:
              preset-sa-gcr-push: "true"
            command: "/kaniko-build"
            env:
              BUILDKITD_FLAGS: "--oci-worker-no-process-sandbox"
            volumes:
              - name: share
                emptyDir: true
              - name: config
                configMapName: kaniko-build-config
            volumeMounts:
              - mountPath: /home/user/.local/share/buildkit
                name: share
              - name: config
                mountPath: /config
                readOnly: true
        jobConfigs:

        # Compass-console repo build jobs
          - repoName: "github.com/kyma-incubator/compass-console"
            jobs:
              - jobConfig:
                  name: pull-compass-console-build
                  args:
                    - "--name=compass-console"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=."
                    - "--dockerfile=compass/Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^compass/|^components/|^shared/|^package.json"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_presubmit
              - jobConfig:
                  name: post-compass-console-build
                  args:
                    - "--name=compass-console"
                    - "--config=/config/kaniko-build-config.yaml"
                    - "--context=."
                    - "--dockerfile=compass/Dockerfile"
                    - "--platform=linux/amd64"
                    - "--platform=linux/arm64"
                  decoration_config:
                    timeout: 60m
                    grace_period: 1m
                  run_if_changed: "^compass/|^components/|^shared/|^package.json"
                  branches:
                    - ^main$
                    - ^master$
                    - ^hotfix-.*$
                inheritedConfigs:
                  local:
                    - image-builder-buildkit
                  global:
                    - jobConfig_postsubmit


