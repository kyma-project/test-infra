{{ $rel := .Global.nextRelease -}}
{{ $relShort := $rel | replace "." "" }}
templates:
  - from: templates/generic.tmpl
    render:
      - to: ../prow/jobs/kyma/releases/kyma-release-{{ $relShort }}.yaml
        localSets:
          bot_token:
            labels:
              preset-kyma-guard-bot-github-token: "true"
              preset-gc-project-env: "true"
          gke_config:
            labels:
              preset-sa-gke-kyma-integration: "true"
              preset-gc-compute-envs: "true"
              preset-docker-push-repository-gke-integration: "true"
              preset-dind-enabled: "true"
              preset-kyma-artifacts-bucket: "true"
              preset-cluster-use-ssd: "true"
              preset-cluster-version: "true"
            request_memory: 200Mi
            request_cpu: 80m
          test-infra:
            extra_refs:
              test-infra:
                - org: kyma-project
                  repo: test-infra
                  path_alias: github.com/kyma-project/test-infra
                  base_ref: release-{{ $rel }}
          request_small:
            request_memory: 100Mi
            request_cpu: 50m
          vm_job_template_k3d:
            annotations:
              pipeline.platform: k3d
              pipeline.installer: kyma deploy
              pipeline.test: fast-integration
              pipeline.clusterprovisioning: k3d
            command: "/home/prow/go/src/github.com/kyma-project/test-infra/prow/scripts/provision-vm-and-start-kyma-k3d.sh"
        jobConfigs:
          - repoName: kyma-project/kyma
            jobs:
              - jobConfig:
                  name: "post-rel{{ $relShort }}-kyma-integration-k3d"
                  # following regexp won't start build if only Markdown files were changed
                  run_if_changed: "^((tests/fast-integration\\S+|resources\\S+|installation\\S+|tools/kyma-installer\\S+)(\\.[^.][^.][^.]+$|\\.[^.][^dD]$|\\.[^mM][^.]$|\\.[^.]$|/[^.]+$))"
                  branches:
                    - ^release-{{ $rel }}$
                  labels:
                    preset-build-release: "true"
                    preset-sa-vm-kyma-integration: "true"
                  annotations:
                    pipeline.platform: k3d
                inheritedConfigs:
                  global:
                    - "jobConfig_default"
                    - "jobConfig_postsubmit"
                    - "image_kyma-integration"
                    - "kyma_major_version_2"
                  local:
                    - "request_small"
                    - "vm_job_template_k3d"
                    - "test-infra"
                    - "bot_token"
              - jobConfig:
                  name: "pre-rel{{ $relShort }}-kyma-integration-k3d"
                  # following regexp won't start build if only Markdown files were changed
                  run_if_changed: "^((tests/fast-integration\\S+|resources\\S+|installation\\S+|tools/kyma-installer\\S+)(\\.[^.][^.][^.]+$|\\.[^.][^dD]$|\\.[^mM][^.]$|\\.[^.]$|/[^.]+$))"
                  branches:
                    - ^release-{{ $rel }}$
                  labels:
                    preset-build-release: "true"
                    preset-sa-vm-kyma-integration: "true"
                  annotations:
                    pipeline.platform: k3d
                inheritedConfigs:
                  global:
                    - "jobConfig_default"
                    - "jobConfig_presubmit"
                    - "image_kyma-integration"
                    - "kyma_major_version_2"
                  local:
                    - "request_small"
                    - "vm_job_template_k3d"
                    - "test-infra"
                    - "bot_token"
              - jobConfig:
                  name: post-rel{{ $relShort }}-kyma-release-candidate
                  branches:
                    - '^{{ $rel }}\.\d+(?:-.*)?$' # release tags
                  annotations:
                    testgrid-dashboards: kyma_release-{{ $rel }}
                    description: Release candidate job for Kyma {{ $rel }}.
                    testgrid-days-of-results: "60"
                  labels:
                    preset-dind-enabled: "true"
                    preset-kyma-artifacts-bucket: "true"
                    preset-sa-gke-kyma-integration: "true"
                    preset-gc-project-env: "true"
                    preset-gke-kyma-developers-group: "true"
                    preset-docker-push-repository-kyma: "true"
                    preset-cluster-version: "true"
                    preset-gc-compute-envs: "true"
                  env:
                    EVENTMESH_SECRET_FILE: "/etc/credentials/kyma-tunas-release-testing-event-mesh/serviceKey"
                  decoration_config:
                    timeout: 3600000000000 # 1h
                    grace_period: 600000000000 # 10min
                  volumes:
                    - name: kyma-tunas-release-testing-event-mesh
                      secretName: kyma-tunas-release-testing-event-mesh
                  volumeMounts:
                    - name: kyma-tunas-release-testing-event-mesh
                      mountPath: /etc/credentials/kyma-tunas-release-testing-event-mesh
                      readOnly: true
                  command: "bash"
                  request_memory: 200Mi
                  request_cpu: 80m
                  args:
                    - "-c"
                    - "${KYMA_PROJECT_DIR}/test-infra/prow/scripts/cluster-integration/kyma-gke-release-candidate.sh"
                inheritedConfigs:
                  global:
                    - "jobConfig_default"
                    - "jobConfig_postsubmit"
                    - "image_kyma-integration"
                  local:
                    - "test-infra"
              - jobConfig:
                  name: post-rel{{ $relShort }}-kyma-gke-release-upgrade
                  branches:
                    - '^{{ $rel }}\.\d+(?:-.*)?$' # release tags
                  env:
                    CLOUDSDK_COMPUTE_ZONE: "europe-west4-b"
                    PROVISION_REGIONAL_CLUSTER: "true"
                    NODES_PER_ZONE: "1"
                    MACHINE_TYPE: "n1-highcpu-16"
                  annotations:
                    testgrid-dashboards: kyma_release-{{ $rel }}
                    testgrid-days-of-results: "90"
                  labels:
                    preset-sa-gke-kyma-integration: "true"
                    preset-bot-github-token: "true"
                    preset-gc-compute-envs: "true"
                    preset-gc-project-env: "true"
                    preset-dind-enabled: "true"
                    preset-docker-push-repository-kyma: "true"
                    preset-cluster-version: "true"
                  command: "bash"
                  args:
                    - "-c"
                    - "/home/prow/go/src/github.com/kyma-project/test-infra/prow/scripts/cluster-integration/kyma-gke-rel2rel-upgrade.sh"
                inheritedConfigs:
                  global:
                    - "jobConfig_default"
                    - "jobConfig_postsubmit"
                    - "image_kyma-integration"
                  local:
                    - "test-infra"
