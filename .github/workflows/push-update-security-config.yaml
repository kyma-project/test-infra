name: push-update-security-config

on:
  schedule:
    - cron: 0 8 * * *
  push:
    branches:
      - main
    paths:
      - '**/*.md'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.tf'
      - '**/*.tfvars'

jobs:
  autobump:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # This is required for requesting the JWT token
      contents: read # This is required for actions/checkout
    concurrency:
      group: post-test-infra-image-detector-autobump
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        # Setup git config with default actions information to prevent error "Unknown committer"
        # See https://github.com/actions/checkout/issues/13#issuecomment-2207006934
      - name: Setup git config
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
      - name: Authenticate in GCP
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: ${{ vars.GCP_KYMA_PROJECT_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GH_COM_KYMA_PROJECT_GCP_WORKLOAD_IDENTITY_FEDERATION_PROVIDER }}

      - name: Get kyma bot token from Secret Manager
        id: 'secrets'
        uses: 'google-github-actions/get-secretmanager-secrets@v2'
        with:
          secrets: |-
            kyma-autobump-token:${{ vars.GCP_KYMA_PROJECT_PROJECT_ID }}/${{ vars.KYMA_AUTOBUMP_BOT_GITHUB_SECRET_NAME }}

      - name: Store Github Token for autobumper
        run: |
          echo ${{ steps.secrets.outputs.kyma-autobump-token }} > ~/token

      - name: Find images to scan
        run: |
          docker run \
            -v ~/token:/etc/github/token:ro \
            -v ${{ github.workspace }}:/github/workspace \
            --workdir /github/workspace \
            --rm \
            --user $UID \
            europe-docker.pkg.dev/kyma-project/prod/test-infra/ko/image-detector:v20240926-f9123aae \
            --terraform-dir=configs/terraform \
            --sec-scanner-config=sec-scanners-config.yaml \
            --autobump-config=configs/autobump-config/test-infra-sec-config-autobump-config.yaml
