name: Reusable Workflow

on: workflow_call
    
jobs:
  use_encrypted_oidc_token:
    runs-on: ubuntu-latest
    steps:
      - name: Download Encrypted OIDC Token
        uses: actions/download-artifact@v4
        with:
          name: oidc-token-encrypted
      - name: Decrypt OIDC Token and Set as Output
        id: decrypt_oidc_token
        run: |
          openssl aes-256-cbc -d -a -in ./oidc_token.enc -out ./oidc_token.txt -pass pass:$ENCRYPTION_SECRET
          oidc_token=$(cat ./oidc_token.txt)
          echo "Decrypted OIDC Token: $oidc_token"
          echo "::set-output name=oidc_token::$oidc_token"
        env:
          ENCRYPTION_SECRET: ${{ secrets.ENCRYPTION_SECRET }}
      - name: Use OIDC Token
        run: |
          echo "Received OIDC Token: $oidc_token"
      - name: Use OIDC Token
        run: |
          echo $oidc_token
      - name: Decode OIDC Token
        run: |
          const token = '$oidc_token';
          const payload = JSON.parse(Buffer.from(token.split('.')[1], 'base64').toString());
          console.log("Decoded JWT payload:", payload);
        shell: node {0}
      - name: Checkout actions-oidc-debugger
        uses: actions/checkout@v4
        with:
          repository: github/actions-oidc-debugger
          ref: main
          path: ./.github/actions/actions-oidc-debugger
      - name: Debug OIDC Claims
        uses: ./.github/actions/actions-oidc-debugger
        with:
          audience: 'https://github.com/github'