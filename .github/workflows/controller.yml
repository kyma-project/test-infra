name: controller
on:
  pull_request_target:
    types: [ opened, edited, synchronize, reopened, ready_for_review ]
  merge_group:
    types: [ checks_requested ]

jobs:
  detect-changed-files:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.pathFilters.outputs.changes }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: pathFilters
        with:
          filters: .github/controller-filters.yaml

  build-automated-approver:
    uses: ./.github/workflows/build-automated-approver.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-automated-approver-paths') }}
  build-cors-proxy:
    uses: ./.github/workflows/build-cors-proxy.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-cors-proxy-paths') }}
  build-dashboard-token-proxy:
    uses: ./.github/workflows/build-dashboard-token-proxy.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-dashboard-token-proxy-paths') }}
  build-github-webhook-gateway:
    uses: ./.github/workflows/build-github-webhook-gateway.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-github-webhook-gateway-paths') }}
  build-image-url-helper:
    uses: ./.github/workflows/build-image-url-helper.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-image-url-helper-paths') }}
  build-markdown-index:
    uses: ./.github/workflows/build-markdown-index.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-markdown-index-paths') }}
  build-usersmapchecker:
    uses: ./.github/workflows/build-usersmapchecker.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-usersmapchecker-paths') }}
  buildx-images:
    uses: ./.github/workflows/buildx-images.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'buildx-images-paths') }}
  build-image-autobumper:
    uses: ./.github/workflows/build-image-autobumper.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-image-autobumper-paths') }}
  build-image-builder:
    uses: ./.github/workflows/build-image-builder.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-image-builder-paths') }}
  build-image-detector:
    uses: ./.github/workflows/build-image-detector.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-image-detector-paths') }}
  build-image-syncer:
    uses: ./.github/workflows/build-image-syncer.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-image-syncer-paths') }}
  build-oidc-token-verifier:
    uses: ./.github/workflows/build-oidc-token-verifier.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-oidc-token-verifier-paths') }}
  build-rotate-service-account-keys:
    uses: ./.github/workflows/build-rotate-service-account-keys.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-rotate-service-account-keys-paths') }}
  build-service-account-keys-cleaner:
    uses: ./.github/workflows/build-service-account-keys-cleaner.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-service-account-keys-cleaner-paths') }}
  build-signify-secret-rotator:
    uses: ./.github/workflows/build-signify-secret-rotator.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-signify-secret-rotator-paths') }}
  build-slack-message-sender:
    uses: ./.github/workflows/build-slack-message-sender.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'build-slack-message-sender-paths') }}
  image-builder-test:
    uses: ./.github/workflows/image-builder-test.yml
    needs: detect-changed-files
    if: ${{ contains(needs.detect-changed-files.outputs.files, 'image-builder-test-paths') }}