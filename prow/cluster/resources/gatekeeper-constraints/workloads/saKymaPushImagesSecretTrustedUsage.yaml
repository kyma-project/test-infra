# Constraint to allow only trusted usage of sa-kyma-push-images gcp service account which has permissions to write images in kyma production oci registry.
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: SecretTrustedUsage
metadata:
  name: sa-kyma-push-images
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaces:
      - "default"
  parameters:
    restrictedSecrets:
      # usually provided with preset-sa-kyma-push-images
      - sa-kyma-push-images
    trustedImages:
      - image: "eu.gcr.io/sap-kyma-neighbors-dev/image-builder:*"
        command:
          - /tools/entrypoint
        args: [ ]
        entrypoint_options: '^{.*"args":\["\/image-builder","--name=.+","--config=\/config\/kaniko-build-config\.yaml","--context=.+","--dockerfile=.+"\],"container_name":"test",.*}$'
        #kyma-dashboard-dev, kyma-dashboard-stage, kyma-dashboard-prod and post-k8s-prow-build-release
      - image: "europe-docker.pkg.dev/kyma-project/prod/testimages/e2e-dind-k3d:*"
        command:
          - /tools/entrypoint
        args: [ ]
        entrypoint_options: '^{.*"args":\["\/docker-credential-gcr configure-docker --registries=europe-docker.pkg.dev"\],"container_name":"test",.*}$'
