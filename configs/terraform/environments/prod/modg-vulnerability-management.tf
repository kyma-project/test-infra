resource "google_service_account" "kyma-modules-reader-modg" {
	account_id   = var.modg-vulnerability-management-artifactregistry-reader.registry_reader_sa
	display_name = var.modg-vulnerability-management-artifactregistry-reader.registry_reader_sa
	description  = var.modg-vulnerability-management-artifactregistry-reader.sa_description
}

resource "google_artifact_registry_repository_iam_member" "kyma_modules_reader_modg" {
	project    = module.kyma_modules.artifact_registry.project
	repository = module.kyma_modules.artifact_registry.name
	location   = module.kyma_modules.artifact_registry.location
	role       = "roles/artifactregistry.reader"
	member     = "serviceAccount:${google_service_account.kyma-modules-reader-modg.email}"
}

resource "google_service_account" "kyma_modules_reader_staging_modg" {
	account_id   = var.staging_modg_vulnerability_management_artifactregistry_reader.registry_reader_sa
	display_name = var.staging_modg_vulnerability_management_artifactregistry_reader.registry_reader_sa
	description  = var.staging_modg_vulnerability_management_artifactregistry_reader.sa_description
}

resource "google_artifact_registry_repository_iam_member" "kyma_modules_reader_staging_modg" {
	project    = module.kyma_modules.artifact_registry.project
	repository = module.kyma_modules.artifact_registry.name
	location   = module.kyma_modules.artifact_registry.location
	role       = "roles/artifactregistry.reader"
	member     = "serviceAccount:${google_service_account.kyma_modules_reader_staging_modg.email}"
}

variable "staging_modg_vulnerability_management_artifactregistry_reader" {
	type = object({
		registry_reader_sa       = string
		sa_description           = string
	})
	default = {
		registry_reader_sa   = "staging-modg-registry-reader"
		sa_description       = "Service account for Staging MODG Vulnerability Management with read-only access to the kyma-modules Artifact Registry."
	}
}

variable "modg-vulnerability-management-artifactregistry-reader" {
	type = object({
		registry_reader_sa       = string
		sa_description           = string
	})
	default = {
		registry_reader_sa   = "modg-vuln-mgmt-reg-reader"
		sa_description     = "Temporary service account for MODG Vulnerability Management with read-only access to the kyma-modules Artifact Registry. Owned by Torsten Dangel."
	}
}

resource "google_secret_manager_secret" "modg_bdba_bot_api_key_staging" {
	project   = var.gcp_project_id
	secret_id = "security-scanner_staging-modg_bdba-bot-api-key-staging"

	replication {
		auto {}
	}

	annotations = {
		bot_name = "bot_kyma-modg-stage@protecode-sc.local"
	}

	labels = {
		type      = "api-key"
		tool      = "security-scanner"
		env       = "staging"
		owner     = "neighbors"
		component = "modg"
		entity = "bot_kyma-modg-stage"
	}
}

resource "google_secret_manager_secret" "modg_github_app_private_key_staging" {
	project   = var.gcp_project_id
	secret_id = "security-scanner_staging-modg_github-app-private-key-staging"

	replication {
		auto {}
	}
	annotations = {
		"github-app-name" = "mODG Stage"
	}

	labels = {
		type      = "private-key"
		tool      = "security-scanner"
		env       = "staging"
		owner     = "neighbors"
		component = "modg"
		entity    = "github_app-private-key"
	}
}

resource "google_secret_manager_secret" "modg_github_app_client_secret_staging" {
	project   = var.gcp_project_id
	secret_id = "security-scanner_staging-modg_github-app-client-secret-staging"

	replication {
		auto {}
	}
	annotations = {
		"github-app-name" = "mODG Stage"
	}

	labels = {
		type      = "private-key"
		tool      = "security-scanner"
		env       = "staging"
		owner     = "neighbors"
		component = "modg"
		entity    = "github_app-client-secret"
	}
}
